<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>PixelGram - Feed</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#fafafa;color:#222}
    .main{max-width:900px;margin:24px auto;padding:12px}
    .post{background:#fff;border-radius:10px;padding:12px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.03)}
    .post img, .post video{width:100%;border-radius:8px;max-height:480px;object-fit:cover}
    .post-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .avatar{width:44px;height:44px;border-radius:50%;background:#ddd;flex:0 0 44px}
    .meta{font-size:13px;color:#666;margin-top:8px}
    .btn{background:#007bff;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .create-post{background:#fff;padding:12px;border-radius:10px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.03)}
    .create-post input[type="text"]{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-top:8px}
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="main" id="main" style="display:none">
    <h2>Feed</h2>

    <!-- CREATE/UPLOAD AREA -->
    <div class="create-post" id="create-post-area" style="display:none">
      <div><strong>Nova publicação</strong></div>
      <input type="file" id="media" accept="image/*,video/*" />
      <input type="text" id="caption" placeholder="Escreve uma legenda..." />
      <div style="margin-top:8px"><button class="btn" id="publish-btn">Publicar</button></div>
      <div id="create-info" style="color:#27ae60;margin-top:8px"></div>
    </div>

    <div id="feed"></div>
  </div>

  <div id="loading" style="text-align:center;padding:40px">A carregar…</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBEesXKUPQibsTXT48pQmL0yfOEHNwE85I",
    authDomain: "pixelgram-fd1bf.firebaseapp.com",
    databaseURL: "https://pixelgram-fd1bf-default-rtdb.firebaseio.com",
    projectId: "pixelgram-fd1bf",
    storageBucket: "pixelgram-fd1bf.firebasestorage.app",
    messagingSenderId: "526005169331",
    appId: "1:526005169331:web:7717c5a46a653e1ddc14c6",
    measurementId: "G-B97XPZM2FN"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // Cloudinary config
  const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dg5zjs1qh/upload';
  const CLOUDINARY_PRESET = 'pixelgram_unsigned';

  // util
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  let currentUser = null;

  auth.onAuthStateChanged(u=>{
    currentUser = u;
    // mostrar feed sempre; publicar só se autenticado
    document.getElementById('main').style.display = '';
    if (u) document.getElementById('create-post-area').style.display = '';
    else document.getElementById('create-post-area').style.display = 'none';
    initFeed();
  });

  // Publish handler
  document.addEventListener('DOMContentLoaded', function(){
    document.getElementById('publish-btn').onclick = publishPost;
  });

  async function publishPost(){
    if (!currentUser) return window.location.href = 'login/index.html';
    const fileEl = document.getElementById('media');
    const caption = document.getElementById('caption').value.trim();
    if (!fileEl.files[0]) return alert('Escolha uma imagem ou vídeo.');
    const file = fileEl.files[0];

    document.getElementById('create-info').textContent = 'A carregar...';

    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY_PRESET);

    try {
      const res = await fetch(CLOUDINARY_URL, { method:'POST', body:fd });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch(e) { data = { raw:text }; }
      console.log('Cloudinary response:', res.status, data);

      if (!res.ok || !data.secure_url) {
        const msg = (data && data.error && data.error.message) ? data.error.message : ('Upload falhou: ' + res.status);
        throw new Error(msg);
      }

      const mediaUrl = data.secure_url;
      const mediaType = file.type.startsWith('image/') ? 'image' : 'video';
      const nameSnap = await db.ref('users/' + currentUser.uid + '/name').once('value');
      const post = {
        uid: currentUser.uid,
        userName: nameSnap.val() || currentUser.email,
        avatar: '',
        mediaUrl,
        mediaType,
        caption,
        timestamp: Date.now()
      };

      await db.ref('posts').push(post);
      document.getElementById('create-info').textContent = 'Publicado com sucesso!';
      fileEl.value = ''; document.getElementById('caption').value = '';
    } catch (err) {
      console.error('Erro ao publicar:', err);
      document.getElementById('create-info').textContent = 'Erro ao publicar: ' + (err.message || '');
      alert('Erro ao publicar: ' + (err.message || 'ver console'));
    } finally {
      setTimeout(()=>document.getElementById('create-info').textContent='',2500);
    }
  }

  // listen posts and render (mostre todas as publicações, incl. updates/removals)
  let postsRef = null;
  const postsMap = {}; // id -> post

  function initFeed(){
    if (postsRef) {
      postsRef.off('child_added');
      postsRef.off('child_changed');
      postsRef.off('child_removed');
    }
    postsRef = db.ref('posts');

    // child_added dispara para entradas existentes e novas — vamos armazenar num mapa e renderizar ordenado
    postsRef.on('child_added', snap => {
      postsMap[snap.key] = { id: snap.key, ...(snap.val() || {}) };
      renderAllPosts();
    });

    postsRef.on('child_changed', snap => {
      postsMap[snap.key] = { id: snap.key, ...(snap.val() || {}) };
      renderAllPosts();
    });

    postsRef.on('child_removed', snap => {
      delete postsMap[snap.key];
      renderAllPosts();
    });
  }

  function renderAllPosts(){
    const feed = document.getElementById('feed');
    const arr = Object.values(postsMap);
    // ordena por timestamp (posts sem timestamp ficam por baixo)
    arr.sort((a,b)=> (b.timestamp || 0) - (a.timestamp || 0));
    feed.innerHTML = '';
    if (!arr.length) {
      feed.innerHTML = '<div style="padding:20px;color:#777;background:#fff;border-radius:8px">Sem publicações</div>';
    } else {
      arr.forEach(p => feed.appendChild(renderPost(p)));
    }
    document.getElementById('loading').style.display = 'none';
  }

  function renderPost(p){
    const el = document.createElement('div');
    el.className = 'post';
    const time = p.timestamp ? new Date(p.timestamp).toLocaleString() : '';
    el.innerHTML = `
      <div class="post-header">
        <div class="avatar"></div>
        <div>
          <div style="font-weight:bold">${escapeHtml(p.userName || p.uid || 'Anónimo')}</div>
          <div style="font-size:12px;color:#888">${escapeHtml(time)}</div>
        </div>
      </div>
    `;
    if (p.mediaType === 'video') {
      const v = document.createElement('video'); v.controls = true; v.src = p.mediaUrl; v.style.width='100%'; el.appendChild(v);
    } else if (p.mediaUrl) {
      const img = document.createElement('img'); img.src = p.mediaUrl; el.appendChild(img);
    }
    const cap = document.createElement('div'); cap.className='meta'; cap.innerHTML = `<strong>${escapeHtml(p.userName||'')}</strong> ${escapeHtml(p.caption||'')}`; el.appendChild(cap);

    const actions = document.createElement('div'); actions.style.marginTop = '8px';
    const likeSpan = document.createElement('span'); likeSpan.style.marginRight='12px';
    actions.appendChild(likeSpan);
    const commLink = document.createElement('a'); commLink.href='#'; commLink.textContent = 'Comentários'; commLink.onclick = (e)=>{ e.preventDefault(); alert('Abrir comentários (implemente se desejar)'); };
    actions.appendChild(commLink);
    el.appendChild(actions);

    // realtime likes counter
    const likesRef = db.ref('posts/' + p.id + '/likes');
    likesRef.on('value', s=>{
      const likes = s.val() || {};
      const count = Object.keys(likes).length;
      likeSpan.textContent = `❤️ ${count}`;
    });

    return el;
  }
</script>
</body>
</html>