<<<<<<< HEAD
<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<title>Perfil — PixelGram</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#fafafa;color:#222;padding:20px}
  .wrap{max-width:900px;margin:0 auto;display:flex;gap:20px}
  .card{background:#fff;padding:16px;border-radius:8px}
  .avatar{width:120px;height:120px;border-radius:50%;object-fit:cover}
  .post{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
<div id="loading">A carregar perfil…</div>
<div id="app" style="display:none">
  <div class="wrap">
    <aside class="card" style="width:260px;text-align:center">
      <img id="avatar" class="avatar" src="" alt="avatar">
      <h2 id="name"></h2>
      <div id="username" style="color:#007bff;margin-bottom:8px"></div>
      <p id="bio"></p>
      <div><strong id="followers">0</strong> Seguidores</div>
      <div><strong id="following">0</strong> Seguindo</div>
      <div style="margin-top:10px">
        <button id="followBtn" style="display:none">Seguir</button>
      </div>
      <div style="margin-top:10px"><a href="/index.html">← Voltar</a></div>
    </aside>
    <main style="flex:1">
      <div id="posts"></div>
    </main>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBEesXKUPQibsTXT48pQmL0yfOEHNwE85I",
    authDomain: "pixelgram-fd1bf.firebaseapp.com",
    databaseURL: "https://pixelgram-fd1bf-default-rtdb.firebaseio.com",
    projectId: "pixelgram-fd1bf",
    storageBucket: "pixelgram-fd1bf.firebasestorage.app",
    messagingSenderId: "526005169331",
    appId: "1:526005169331:web:7717c5a46a653e1ddc14c6",
    measurementId: "G-B97XPZM2FN"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  const parts = window.location.pathname.split('/').filter(Boolean);
  const username = decodeURIComponent(parts[parts.length-1] || '').toLowerCase();

  if (!username) {
    document.getElementById('loading').innerText = 'Username inválido na URL.';
  } else {
    (async ()=>{
      // resolve username -> uid
      const mapSnap = await db.ref('usernames/' + username).once('value');
      let uid = mapSnap.val();
      if (!uid) {
        // fallback: try search by users.username
        const q = await db.ref('users').orderByChild('username').equalTo(username).once('value');
        if (q.exists()) uid = Object.keys(q.val())[0];
      }
      if (!uid) {
        document.getElementById('loading').innerText = 'Perfil não encontrado.';
        return;
      }
      const uSnap = await db.ref('users/' + uid).once('value');
      const u = uSnap.val() || {};
      document.getElementById('avatar').src = u.avatar || 'https://via.placeholder.com/120';
      document.getElementById('name').innerText = u.name || u.username || username;
      document.getElementById('username').innerText = '@' + (u.username || username);
      document.getElementById('bio').innerText = u.bio || '';
      document.getElementById('followers').innerText = u.followers ? Object.keys(u.followers).length : 0;
      document.getElementById('following').innerText = u.following ? Object.keys(u.following).length : 0;

      // load posts
      const postsSnap = await db.ref('posts').orderByChild('uid').equalTo(uid).once('value');
      const postsDiv = document.getElementById('posts');
      postsDiv.innerHTML = '';
      if (!postsSnap.exists()) postsDiv.innerHTML = '<div class="post">Sem publicações</div>';
      postsSnap.forEach(p=>{
        const v = p.val();
        const div = document.createElement('div'); div.className='post';
        let media = '';
        if (v.mediaType === 'video') media = `<video controls style="width:100%;max-height:420px">${''}<source src="${escapeHtml(v.mediaUrl)}"></video>`;
        else if (v.mediaUrl) media = `<img src="${escapeHtml(v.mediaUrl)}" style="width:100%;border-radius:6px">`;
        div.innerHTML = `<div style="font-weight:bold">${escapeHtml(v.userName||u.name||u.username)}</div>
                         <div style="color:#666;font-size:13px">${new Date(v.timestamp||0).toLocaleString()}</div>
                         ${media}
                         <div style="margin-top:6px">${escapeHtml(v.caption||'')}</div>`;
        postsDiv.appendChild(div);
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = '';
      // follow button logic (optional)
      auth.onAuthStateChanged(me=>{
        const btn = document.getElementById('followBtn');
        if (!me || me.uid === uid) { btn.style.display = 'none'; return; }
        btn.style.display = '';
        db.ref('users/' + uid + '/followers/' + me.uid).once('value').then(s=>{
          const isFollowing = s.exists();
          btn.innerText = isFollowing ? 'A seguir' : 'Seguir';
        });
        btn.onclick = async ()=>{
          const fRef = db.ref('users/' + uid + '/followers/' + me.uid);
          const myFollowingRef = db.ref('users/' + me.uid + '/following/' + uid);
          const s = await fRef.once('value');
          if (s.exists()) { await fRef.remove(); await myFollowingRef.remove(); btn.innerText='Seguir'; }
          else { await fRef.set(true); await myFollowingRef.set(true); btn.innerText='A seguir'; }
        };
      });
    })().catch(err=>{
      console.error(err);
      document.getElementById('loading').innerText = 'Erro ao carregar.';
    });
  }
</script>
</body>
</html>
=======
>>>>>>> parent of 9768400 ([Atualização de perfis])
